# Bevy 学习笔记

启动

```sh
# 桌面启动
cargo run --features desktop
cargo run --features desktop --release
# 打包安卓so文件
cargo ndk -t arm64-v8a -o ./jniLibs build --release --features android
cargo ndk -t x86_64 -o ./jniLibs build --release --features android
```

默认字体路径
D:\DPFS\Rust\.cargo\registry\src\mirrors.ustc.edu.cn-38d0e5eb5da2abae\bevy_text-0.17.2\src
D:\DPFS\Rust\.cargo\registry\src\mirrors.ustc.edu.cn-38d0e5eb5da2abae\epaint_default_fonts-0.33.0\fonts

GameActivity

```kotlin
package com.dqq.dqwm

import android.os.Bundle
import android.view.View
import androidx.core.view.ViewCompat
import androidx.core.view.WindowInsetsCompat
import com.google.androidgamesdk.GameActivity

class MainActivity : GameActivity() {
    companion object {
        init {
            System.loadLibrary("dqwm")
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // 告诉系统：我不要延伸到系统栏
        window.setDecorFitsSystemWindows(false)

        // 设置内容区域避让系统栏
        ViewCompat.setOnApplyWindowInsetsListener(window.decorView) { view, insets ->
            val systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars())
            view.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom)
            insets
        }
    }

    override fun onWindowFocusChanged(hasFocus: Boolean) {
        super.onWindowFocusChanged(hasFocus)
        if (hasFocus) {
            hideSystemUi()
        }
    }

    private fun hideSystemUi() {
        val decorView = window.decorView
        decorView.systemUiVisibility = (
                //View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY // 屏幕边缘滑出后，系统只会临时显示
                View.SYSTEM_UI_FLAG_LAYOUT_STABLE   //布局稳定,隐藏了，也继续为我保留同样的窗口
                // or View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION // 把导航栏也算进布局区域
                // or View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN //允许内容画到状态栏背后；系统不再给状态栏留顶边距
                // or View.SYSTEM_UI_FLAG_HIDE_NAVIGATION //立即隐藏导航栏（底部三键/手势条）。
                //or View.SYSTEM_UI_FLAG_FULLSCREEN //立即隐藏状态栏（时间、电量、通知图标那一行）
        )
    }
}


```

# 2025-11-08 V1.0.0

```rust
use bevy::{
    color::palettes::css::RED,
    diagnostic::{FrameTimeDiagnosticsPlugin, LogDiagnosticsPlugin},
    prelude::*,
};
use bevy_inspector_egui::{bevy_egui::EguiPlugin, quick::WorldInspectorPlugin};

#[bevy_main]
pub fn main() {
    App::new()
        .add_plugins((
            DefaultPlugins.set(WindowPlugin {
                primary_window: Some(Window {
                    title: "道起微末".into(),
                    name: Some("道起微末".into()),
                    position: WindowPosition::Centered(MonitorSelection::Primary), // 居中
                    resolution: (300, 533).into(),                                 // 窗口大小
                    ..default()
                }),
                ..default()
            }),
            LogDiagnosticsPlugin::default(),
            FrameTimeDiagnosticsPlugin::default(),
        ))
        .add_plugins((EguiPlugin::default(), WorldInspectorPlugin::new()))
        .add_systems(Startup, setup)
        .add_systems(Update, button_system)
        .run();
}

fn setup(mut commands: Commands, asset_server: Res<AssetServer>) {
    commands.spawn(Camera2d);

    commands.spawn(bottom_navigation()).with_children(|parent| {
        parent.spawn((nav_button("资源"),));
        parent.spawn((nav_button("游戏"),));
        parent.spawn((nav_button("设置"),));
        parent.spawn((nav_button("关于"),));
    });

    commands.spawn((
        Node {
            width: Val::Percent(100.0),
            height: Val::Percent(100.0),
            position_type: PositionType::Absolute,
            ..default()
        },
        ImageNode {
            image: asset_server.load("bg.jpg").into(),
            ..default()
        },
        ZIndex(-99999),
    ));
    // 放一个文本测试
    commands.spawn((
        Text::new("测试"),
        TextFont {
            font_size: 32.0,
            ..default()
        },
        Test11,
    ));
}

#[derive(Component)]
struct Test11;

// 实现底部导航

#[derive(Component)]
struct BottomNavigation;

//  底部导航按钮
#[derive(Component)]
struct NavButton;

fn bottom_navigation() -> impl Bundle {
    (
        Node {
            width: percent(100),
            height: Val::Auto,
            position_type: PositionType::Absolute, // 关键：绝对定位
            bottom: Val::Px(0.),                   // 贴底
            left: Val::Px(0.),                     // 从左开始
            flex_direction: FlexDirection::Row,    // 关键 1：横向排列
            column_gap: Val::Px(5.0),              // 列间距
            justify_content: JustifyContent::SpaceEvenly, // 关键 2：间距均分
            align_items: AlignItems::Center,       // 垂直居中

            padding: UiRect {
                // 边距
                left: Val::Px(0.0),
                right: Val::Px(0.0),
                top: Val::Px(8.0),
                bottom: Val::Px(8.0),
            },
            ..default()
        },
        BottomNavigation,
        ZIndex(99999),
    )
}

/// 单个子按钮：flex_grow = 1 保证等宽
fn nav_button(text: &str) -> impl Bundle {
    // 外层容器：处理宽度、边距、flex_grow
    (
        Node {
            flex_grow: 1.,
            height: percent(100.),
            margin: UiRect::all(Val::Px(3.0)), // 边距在外层
            ..default()
        },
        // 内层容器：处理边框和内容
        children![(
            Node {
                width: percent(100.), // 内层占满外层
                height: percent(100.),
                justify_content: JustifyContent::Center,
                align_items: AlignItems::Center,
                border: UiRect::all(Val::Px(0.5)), // 边框在内层
                ..default()
            },
            BorderColor::all(Color::WHITE),
            BackgroundColor(Color::srgba(0., 0., 255., 1.)),
            Button,
            children![(
                Text::new(text),
                TextFont {
                    font_size: 32.0,
                    ..default()
                },
                NavButton
            )],
        )],
    )
}

fn button_system(
    mut interaction_query: Query<(&Interaction, &mut BorderColor, &Children), Changed<Interaction>>,
    mut label_query: Query<&mut Text, With<Test11>>, // 只改标签
    btn_text_q: Query<&Text, Without<Test11>>,       // 只读按钮文字
) {
    // 先获取标签的可变引用
    let mut label = label_query.single_mut().unwrap();

    for (interaction, mut border_color, children) in &mut interaction_query {
        // 获取按钮文字的只读引用
        let btn_text = &**btn_text_q.get(children[0]).unwrap();

        match *interaction {
            Interaction::Pressed => {
                // 修改标签文字
                **label = format!("按钮说：{}", btn_text);
                *border_color = BorderColor::all(RED);
                border_color.set_changed();
            }
            Interaction::Hovered => {
                // 悬停时的逻辑
            }
            Interaction::None => {
                // 无交互时的逻辑
            }
        }
    }
}

```

```toml
[package]
name = "dqwm"
version = "0.1.0"
edition = "2024"

[lib]
name = "dqwm"
path = "src/lib.rs"
crate-type = ["lib","cdylib"]


[[bin]]
name = "dqwm_desktop"
path = "src/main.rs"
required-features = ["desktop"]

[dependencies]
eframe = "0.33.0"
egui = "0.33.0"



[features]
android = []
desktop = []

[profile.release]
opt-level = "z"       # ③ 最高优化
lto = "thin"          # ① 链接秒级
codegen-units = 16    # ② 并行生成
strip = true          # 自动 strip 符号表（Rust 1.77+）


```

# 运行安卓

cargo ndk -t arm64-v8a -o ./jniLibs build --release --features android

#

cargo install -f cargo-binutils #[cfg(feature = "desktop")]

cargo ndk -t arm64-v8a -o ./jniLibs build --release
cargo ndk -t x86_64 -o ./jniLibs build --release

cargo ndk -t x86_64 -o ./jniLibs build --release --features android
cargo ndk -t arm64-v8a -o ./jniLibs build --release --features android

rustup target add x86_64-linux-android
cargo ndk -t arm64-v8a -t x86_64 -o ./jniLibs build --release

use tokio::time::{sleep, Duration,Instant};

pub struct Resource {
pub id: u32, // 资源 ID
pub name: String, // 资源名称
pub value: u128, // 当前值
pub max: u128, // 最大值
pub change: u128, // 变化量
pub interval: u64, // 周期
pub last_tick: u64, // 上一次刷新时间
pub due_tick: u64, // 到期时间
}

use std::{collections::{BTreeMap, HashMap}, sync::Arc};

#[derive(Debug, Clone, Default, PartialEq)] #[warn(dead_code)] //TODO 后面删除
struct DQWMResource {
id: i32, // 唯一标识符
name: String, // 资源名称
description: String, // 资源描述
value: u128, // 资源值
max: u128, // 资源最大值
change: u128, // 资源变化值
interval: u16, // 资源刷新间隔 0 表示不刷新,1000 代表 1 秒更新一次
next_tick: u64, // 下一次到期时间
last_update_at: u64, // 最后一次更新时间
}

impl DQWMResource{

    //设置资源值
    #[inline]
    pub fn set_value(&mut self, value: u128) {
        self.value = (value + self.change).min(self.max);
    }

    // 补收益
    #[inline]
    pub fn catch_up(&mut self) {
        self.set_value( (now_ms() - (self.last_update_at as u128) ) / (self.interval as u128) )
    }

}

struct DQWMResourceMgr{
\_resources: Vec<DQWMResource>, // 资源列表
\_is_stop: bool // 运行状态, 默认 true
}

impl DQWMResourceMgr{

    fn _run(&mut self){
        // 找到最近的一批
        let now =   now_ms();
        let expire:Vec<_> = self._resources.iter()

        .collect();

        expire.iter().for_each(|i| println!("{:?}", i));

    }

}

// 获取当前时间毫秒数 #[inline]
fn now_ms() -> u128 {
use std::time::{SystemTime, UNIX_EPOCH};
SystemTime::now()
.duration_since(UNIX_EPOCH)
.unwrap()
.as_millis()
}

// 资源 ID

fn main() {
let dqwm_resource_mgr = DQWMResourceMgr();
dqwm_resource_mgr.

}

// 添加
cargo add A
// 运行
cargo run

[package]
name = "dqwm"
version = "0.1.0"
edition = "2024"

[dependencies]

# rhai = { version = "1.16", features = ["sync", "serde", "only_i64"] }

# serde = { version = "1.0", features = ["derive"] }

# serde_json = "1.0"

# thiserror = "1.0"

# anyhow = "1.0"

eframe = { version = "0.33.0", features = ["glow"] }
egui = "0.33.0" #
egui_extras = "0.33.0"

#[derive(Debug, Clone, Default, PartialEq)]
struct GameResource {
id: i32, // 唯一标识符
name: String, // 资源名称
description: String, // 资源描述
value: i128, // 资源值
max_value: i128, // 资源最大值
change_value: f64, // 资源变化值
current_interval: i8, // 当前资源刷新间隔
interval: i8, // 资源刷新间隔
last_refresh_time: i64, // 最后一次刷新时间
}

// 来源
// #[derive(Debug, Clone, Default, PartialEq)]
// struct Bonus {
// id: i32, // 唯一标识符
// name: String, // 来源名称
// target_ids: Vec<i32>, // 目标资源标识符
// description: String, // 来源描述
// value: i128, // 来源值
// rate: f64, // 来源比例
// area_name: String, // 区域名称
// }

// 来源管理
pub struct BonusManager {
inner: Vec<Bonus>, // 来源列表
}

/// 1. 策划配表，全局只读 #[derive(Debug, Clone, Copy)]
pub struct BaseUnitTemp {
pub id: u32, // id
pub name: &'static str, // 名字
pub base_atk: u128, // 攻击
pub base_hp: u128, // 生命
pub base_def: u128, // 防御
pub base_crit_rate: f64, // 暴击率
pub base_crit_damage: f64, // 暴击伤害
pub base_hit_rate: f64, // 命中率
pub base_dodge_rate: f64, // 闪避率
pub base_attack_speed: f64, // 攻击速度
pub base_life_steal: f64, // 生命偷取
}

/// 2. 账号维度：在基础值上叠加养成、装备、科技等加成
/// 只存“当前值”，不存历史 delta #[derive(Debug, Clone)]
pub struct UnitTemp {
pub base_temp_id: u32, // 对应 BaseUnitTemp.id
pub name: String,
pub atk: u128, // 当前攻击
pub hp: u128,
pub def: u128,
pub crit_rate: f64, // 暴击率
pub crit_damage: f64, // 暴击伤害
pub hit_rate: f64, // 命中率
pub dodge_rate: f64, // 闪避率
pub attack_speed: f64, // 攻击速度
pub life_steal: f64, // 生命偷取
}

#[derive(Debug, Clone)]
pub struct Unit {
pub temp_id: u32,
pub name: String,
pub atk: u128,
pub hp: u128,
pub def: u128,
pub crit_rate: f64, // 暴击率
pub crit_damage: f64, // 暴击伤害
pub hit_rate: f64, // 命中率
pub dodge_rate: f64, // 闪避率
pub attack_speed: f64, // 攻击速度
pub life_steal: f64, // 生命偷取
}

// 动态执行

use rhai::{Engine, Map, AST};
use std::time::Instant;

fn main() {
let engine = Engine::new();
let ast: AST = engine
.compile(r#"
if lv > 10 { #{"1001": 5*lv, "1005": 50*lv} }
else { #{"1001": 2*lv, "1005": 20*lv} }
"#)
.unwrap();

    let mut scope = rhai::Scope::new();
    // 预热一次，避免 AST 懒加载干扰
    scope.push("lv", 15_i64);
    let _: Map = engine.eval_ast_with_scope(&mut scope, &ast).unwrap();

    const N: usize = 10000;
    let start = Instant::now();

    for _ in 0..N {
        // 每次只换变量，不重新编译
        scope.push("lv", 15_i64);
        let _: Map = engine.eval_ast_with_scope(&mut scope, &ast).unwrap();
    }

    let elapsed = start.elapsed();
    println!(
        "1000 次总耗时 {:?}，单次平均 {:?}",
        elapsed,
        elapsed / N as u32
    );

}
